= form_with(                                                                         |
        scope: :passkey,                                                             |
        url: user_passkeys_url,                                                      |
        method: :post,                                                               |
        id: :"add-passkey-form",                                                     |
        data: {                                                                      |
          "reauthentication_challenge_url": new_user_reauthentication_challenge_url, |
          "reauthentication_token_url": user_reauthentication_url,                   |
          "reauthentication_token_field_name": "passkey[reauthentication_token]",    |
          "challenge_url": new_create_challenge_user_passkeys_url,                   |
          "credential_field_name": "passkey[credential]"                             |
        }                                                                            |
  ) do |f|                                                                           |
  %h2 Add a passkey
  %fieldset
    %button#unlock-button{type: "button"}
      Unlock
    = f.text_field :reauthentication_token, readonly: true
  %fieldset#new-passkey-fields{disabled: "disabled"}
    %table
      %tr
        %th= f.label :label
        %td
          = f.text_field :label, autofocus: "off", required: true
    = f.hidden_field :credential
    %button{type: "submit"}
      Add passkey
%script{type: "module"}
  :cdata
    import {getReauthenticationToken} from 'passkey_reauthentication_handler'
    import {submitFormEvent} from 'registration_form'
    
    let unlockFormEvent = async function(event){
    let unlockButton = event.currentTarget
    let form = unlockButton.closest('form')
      await getReauthenticationToken(form)
      form.querySelector('#new-passkey-fields').removeAttribute("disabled")
    }
    
    document.querySelector('#unlock-button').addEventListener('click', unlockFormEvent)
    document.querySelector('#add-passkey-form').addEventListener('submit', submitFormEvent)